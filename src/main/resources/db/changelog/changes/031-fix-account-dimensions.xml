<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="031-fix-account-dimensions-v3" author="system">
        <comment>Fix account dimensions for 1010xxx, 1020xxx, 1030xxx, 1090xxx accounts based on corrected specification</comment>
        
        <sql>
            -- ========================================
            -- FIX NON-CURRENT ASSETS DIMENSIONS
            -- ========================================
            
            -- Fix 1010000 - Remove ALL dimensions (Level 2 account)
            DELETE FROM account_dimensions 
            WHERE account_id = (SELECT account_id FROM chart_of_accounts WHERE account_code = '1010000');
            
            -- 1. Delete incorrect dimensions for 1010300 (should only have FIXED_ASSET)
            DELETE FROM account_dimensions 
            WHERE account_id = (SELECT account_id FROM chart_of_accounts WHERE account_code = '1010300')
            AND dimension_type IN ('ITEM', 'WAREHOUSE');
            
            -- 2. Fix 1010400 - Remove ITEM and WAREHOUSE, add EXPENSE_ITEM
            DELETE FROM account_dimensions 
            WHERE account_id = (SELECT account_id FROM chart_of_accounts WHERE account_code = '1010400')
            AND dimension_type IN ('ITEM', 'WAREHOUSE');

            INSERT INTO account_dimensions (account_id, dimension_type, turnovers_only, track_amount, track_quantitative)
            SELECT account_id, 'EXPENSE_ITEM', false, true, false 
            FROM chart_of_accounts 
            WHERE account_code = '1010400'
            AND NOT EXISTS (
                SELECT 1 FROM account_dimensions ad 
                WHERE ad.account_id = chart_of_accounts.account_id 
                AND ad.dimension_type = 'EXPENSE_ITEM'
            );
            
            -- 3. Fix 1010500 - Remove FIXED_ASSET, keep ITEM and WAREHOUSE
            DELETE FROM account_dimensions 
            WHERE account_id = (SELECT account_id FROM chart_of_accounts WHERE account_code = '1010500')
            AND dimension_type = 'FIXED_ASSET';
            
            -- 4. Fix 1010600 - Add EXPENSE_ITEM as dimension 2
            INSERT INTO account_dimensions (account_id, dimension_type, turnovers_only, track_amount, track_quantitative)
            SELECT account_id, 'EXPENSE_ITEM', false, true, false 
            FROM chart_of_accounts 
            WHERE account_code = '1010600'
            AND NOT EXISTS (
                SELECT 1 FROM account_dimensions ad 
                WHERE ad.account_id = chart_of_accounts.account_id 
                AND ad.dimension_type = 'EXPENSE_ITEM'
            );
            
            -- ========================================
            -- FIX INVESTMENT PROPERTY DIMENSIONS
            -- ========================================
            
            -- 5. Fix 1020000 - Remove FIXED_ASSET dimension (parent account should have no dimensions)
            DELETE FROM account_dimensions 
            WHERE account_id = (SELECT account_id FROM chart_of_accounts WHERE account_code = '1020000');
            
            -- 6. Fix 1020100-1020400 - Change FIXED_ASSET to INVESTMENT_PROPERTY
            DELETE FROM account_dimensions 
            WHERE account_id IN (SELECT account_id FROM chart_of_accounts WHERE account_code IN ('1020100', '1020200', '1020300', '1020400'))
            AND dimension_type = 'FIXED_ASSET';
            
            INSERT INTO account_dimensions (account_id, dimension_type, turnovers_only, track_amount, track_quantitative)
            SELECT account_id, 'INVESTMENT_PROPERTY', false, true, false 
            FROM chart_of_accounts 
            WHERE account_code IN ('1020100', '1020200', '1020300', '1020400')
            AND NOT EXISTS (
                 SELECT 1 FROM account_dimensions ad 
                 WHERE ad.account_id = chart_of_accounts.account_id 
                 AND ad.dimension_type = 'INVESTMENT_PROPERTY'
            );
            
            -- 7. Fix 1020400 - Remove EXPENSE_ITEM (should only have INVESTMENT_PROPERTY)
            DELETE FROM account_dimensions 
            WHERE account_id = (SELECT account_id FROM chart_of_accounts WHERE account_code = '1020400')
            AND dimension_type = 'EXPENSE_ITEM';
            
            -- 8. Fix 1020500, 1020600 - Already have FIXED_ASSET + EXPENSE_ITEM (correct)
            -- No action needed for these
            
            -- ========================================
            -- FIX INTANGIBLE ASSETS DIMENSIONS
            -- ========================================
            
            -- 9. Fix 1030000 - Remove FIXED_ASSET dimension (parent account should have no dimensions)
            DELETE FROM account_dimensions 
            WHERE account_id = (SELECT account_id FROM chart_of_accounts WHERE account_code = '1030000');
            
            -- 10. Fix 1030400, 1030500 - Add EXPENSE_ITEM
            INSERT INTO account_dimensions (account_id, dimension_type, turnovers_only, track_amount, track_quantitative)
            SELECT account_id, 'EXPENSE_ITEM', false, true, false 
            FROM chart_of_accounts 
            WHERE account_code IN ('1030400', '1030500')
            AND NOT EXISTS (
                SELECT 1 FROM account_dimensions ad 
                WHERE ad.account_id = chart_of_accounts.account_id 
                AND ad.dimension_type = 'EXPENSE_ITEM'
            );
            
            -- ========================================
            -- FIX OTHER NON-CURRENT ASSETS
            -- ========================================
            
            -- 11. Fix 1090100, 1090200 - Should have ITEM only (no WAREHOUSE)
            DELETE FROM account_dimensions 
            WHERE account_id IN (SELECT account_id FROM chart_of_accounts WHERE account_code IN ('1090100', '1090200'))
            AND dimension_type = 'WAREHOUSE';
            
            INSERT INTO account_dimensions (account_id, dimension_type, turnovers_only, track_amount, track_quantitative)
            SELECT account_id, 'ITEM', false, true, false 
            FROM chart_of_accounts 
            WHERE account_code IN ('1090100', '1090200')
            AND NOT EXISTS (
                SELECT 1 FROM account_dimensions ad 
                WHERE ad.account_id = chart_of_accounts.account_id 
                AND ad.dimension_type = 'ITEM'
            );
        </sql>
    </changeSet>

</databaseChangeLog>
